# PocketBase 钩子脚本管理界面设计

## 1. 背景

PocketBase 目前通过加载 `pb_hooks` 目录下的 JavaScript 脚本文件来实现钩子功能。这种方式虽然简单直接，但对于开发和维护来说存在一些不便：

- 需要直接访问服务器文件系统
- 无法在界面上直接编辑和管理脚本
- 缺乏版本控制和历史记录
- 多环境部署时需要同步脚本文件

为了解决这些问题，我们计划设计一个前端管理界面，允许用户在 Web 界面上编辑和管理钩子脚本，并将脚本保存到内置数据库中。

## 2. 系统架构

### 2.1 数据模型

我们将创建以下数据集合来存储钩子脚本：

#### 2.1.1 `pb_hooks_scripts` 集合

| 字段名 | 类型 | 描述 |
|--------|------|------|
| id | ID | 主键 |
| name | Text | 脚本名称 |
| description | Text | 脚本描述 |
| code | Editor | 脚本代码内容 |
| type | Select | 脚本类型（如：collection, record, api, system等） |
| event | Select | 触发事件（如：create, update, delete等） |
| collection | Relation | 关联的集合（可选，仅当type为collection或record时） |
| enabled | Boolean | 是否启用 |
| order | Number | 执行顺序 |
| created | Date | 创建时间 |
| updated | Date | 更新时间 |
| created_by | Relation | 创建者（关联到_superusers） |
| updated_by | Relation | 更新者（关联到_superusers） |

#### 2.1.2 `pb_hooks_versions` 集合（可选，用于版本控制）

| 字段名 | 类型 | 描述 |
|--------|------|------|
| id | ID | 主键 |
| script | Relation | 关联的脚本 |
| code | Editor | 脚本代码内容 |
| comment | Text | 版本说明 |
| created | Date | 创建时间 |
| created_by | Relation | 创建者（关联到_superusers） |

### 2.2 系统组件

1. **数据库适配器**：负责从数据库加载脚本并注册到钩子系统
2. **钩子管理API**：提供CRUD操作接口
3. **前端管理界面**：提供脚本编辑、测试和管理功能
4. **脚本执行引擎**：负责执行数据库中的脚本

## 3. 功能设计

### 3.1 钩子脚本加载机制

1. 系统启动时，从数据库加载所有启用的钩子脚本
2. 根据脚本类型和事件类型，将脚本注册到相应的钩子处理器
3. 当触发事件时，按照脚本的order字段顺序执行相应的脚本

### 3.2 前端管理界面

#### 3.2.1 脚本列表页面

- 显示所有脚本的列表，包括名称、类型、事件、状态等信息
- 提供筛选、排序功能
- 支持启用/禁用脚本
- 支持创建、编辑、删除脚本

#### 3.2.2 脚本编辑页面

- 提供代码编辑器，支持语法高亮、自动完成等功能
- 提供脚本元数据编辑（名称、描述、类型等）
- 支持保存版本和查看历史版本
- 提供测试功能，可以模拟事件触发并查看执行结果

### 3.3 API设计

#### 3.3.1 脚本管理API

- `GET /api/hooks` - 获取所有脚本列表
- `GET /api/hooks/:id` - 获取单个脚本详情
- `POST /api/hooks` - 创建新脚本
- `PATCH /api/hooks/:id` - 更新脚本
- `DELETE /api/hooks/:id` - 删除脚本
- `POST /api/hooks/:id/toggle` - 启用/禁用脚本
- `POST /api/hooks/:id/test` - 测试脚本执行

#### 3.3.2 版本管理API（可选）

- `GET /api/hooks/:id/versions` - 获取脚本的所有版本
- `GET /api/hooks/:id/versions/:versionId` - 获取特定版本详情
- `POST /api/hooks/:id/versions` - 创建新版本
- `POST /api/hooks/:id/versions/:versionId/restore` - 恢复到特定版本

## 4. 实现计划

### 4.1 后端实现

1. 创建数据模型和集合
2. 实现数据库适配器，用于加载和注册脚本
3. 实现钩子管理API
4. 修改现有的钩子系统，支持从数据库加载脚本

### 4.2 前端实现

1. 设计并实现脚本列表页面
2. 设计并实现脚本编辑页面
3. 集成代码编辑器（如Monaco Editor）
4. 实现版本管理功能（可选）

## 5. 安全考虑

1. 只有超级用户（_superusers）可以管理钩子脚本
2. 脚本执行时需要进行沙箱隔离，防止恶意代码
3. 敏感操作需要记录日志
4. 考虑添加脚本执行超时机制，防止无限循环

## 6. 兼容性考虑

为了保持向后兼容性，系统将同时支持两种钩子加载方式：

1. 从文件系统加载（现有方式）
2. 从数据库加载（新方式）

用户可以通过配置选择使用哪种方式，或者同时使用两种方式（数据库中的脚本优先级更高）。

## 7. 未来扩展

1. 支持脚本模板，方便快速创建常用脚本
2. 支持脚本导入/导出功能
3. 添加脚本执行统计和性能监控
4. 支持脚本依赖管理
5. 支持更多脚本语言（如TypeScript）

## 8. 结论

通过实现钩子脚本的数据库存储和前端管理界面，我们可以大大提高PocketBase钩子系统的可用性和维护性。这将使开发者能够更方便地创建、测试和管理钩子脚本，同时也为多环境部署提供更好的支持。